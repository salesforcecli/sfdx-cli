---
version: 2.1
orbs:
  release-management: salesforce/npm-release-management@4
  jq: circleci/jq@2.2
  slack: circleci/slack@3.4.2

parameters:
  workflow:
    description: >
      String that controls which workflow would run.

      This parameter is used by automation to determine if a workflow will run
      within a pipeline.
    type: string
    default: 'test-and-release'

jobs:
  promote-channels:
    docker:
      - image: node:lts
    steps:
      - checkout
      - jq/install
      - restore_cache:
          keys:
            - v3-npm-{{checksum "yarn.lock"}}
      - run: yarn install
      - run: ./scripts/promote-rc-to-latest

  change-case-start:
    docker:
      - image: node:latest
    steps:
      - release-management/install-change-case-mgmt
      - release-management/change-case-create

  npm-promotions:
    docker:
      - image: node:latest
    steps:
      - checkout
      - jq/install
      - run: echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
        # if you try to use yarn here, it will attempt to use the wrong registry and throw 401s
      - run: npm run promote-dist-tags

  docker-promotions:
    docker:
      - image: cimg/node:lts
    steps:
      - checkout
      - run: yarn install --ignore-scripts
      - setup_remote_docker
      - run: echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
      - run: yarn promote-docker

  promote-verify:
    docker:
      - image: node:lts
    steps:
      - checkout
      - jq/install
      - run: ./scripts/verify-promote
      - release-management/install-sf-release
      - run: sf-release cli:versions:inspect -c stable -l archive
      - slack/notify:
          channel: 'cli-team-notifications'
          color: '#9bcd9b'
          message: '`sfdx-cli` (version X.XXX.X) has been promoted to latest. :tada2: Release notes: https://github.com/forcedotcom/cli/blob/master/releasenotes/README.md'
      - slack/status:
          channel: 'cli-team-alerts'
          fail_only: true

  close-CTC:
    docker:
      - image: node:latest
    steps:
      - release-management/install-change-case-mgmt
      - run:
          when: on_fail
          name: Close CTC case as Not Implemented
          command: |
            if [ -z "${SF_CHANGE_CASE_SFDX_AUTH_URL}" ] || [ -z "${SF_CHANGE_CASE_TEMPLATE_ID}" ] || [ -z "${SF_CHANGE_CASE_SCHEDULE_BUILD}" ]; then
                echo "Environment not configured for CTC"
            else
                sfchangecase close --location "https://github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME" --status "Not Implemented"
            fi
      - run:
          name: All Good! Close CTC case/implementations
          when: on_success
          command: |
            if [ -z "${SF_CHANGE_CASE_SFDX_AUTH_URL}" ] || [ -z "${SF_CHANGE_CASE_TEMPLATE_ID}" ] || [ -z "${SF_CHANGE_CASE_SCHEDULE_BUILD}" ]; then
                echo "Environment not configured for CTC"
            else
                sfchangecase close --location "https://github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME"
            fi

workflows:
  version: 2
  promote-to-latest:
    when:
      equal: ['promote-to-latest', << pipeline.parameters.workflow >>]
    jobs:
      # start the change case
      - change-case-start:
          context:
            - CLI_CTC
            - cli-release

      - promote-channels:
          context:
            - AWS
            - cli-release
          requires:
            - change-case-start
      - docker-promotions:
          context: cli-release
          requires:
            - change-case-start
      - npm-promotions:
          context: cli-release
          requires:
            - change-case-start
      # close change case
      - close-CTC:
          context:
            - CLI_CTC
            - cli-release
          requires:
            - npm-promotions
            - promote-channels
      # verify the npm tags and installers are on the right version
      - promote-verify:
          requires:
            - npm-promotions
            - promote-channels
          context: slack
