#!/usr/bin/env bash

set -ex

export OS=darwin
export ARCH=x64

source ./scripts/release/_init
source ./scripts/_github

MOBILECI_BASE_URL=$MOBILECI_BASE_URL
GIT_TOKEN=$GIT_TOKEN
GIT_BASE="https://api.github.com/repos/salesforcecli/sfdx-cli"

MOBILECI_MACOS_INSTALLER_TOKEN="${MOBILECI_MACOS_INSTALLER_TOKEN:-}"
if [[ -z "$MOBILECI_MACOS_INSTALLER_TOKEN" ]]; then
    stderr "[WARN] MOBILECI_MACOS_INSTALLER_TOKEN is undefined"
fi

VERSIONED_INSTALLER_NAME="$INSTALLER_BASE_NAME.pkg"
UNVERSIONED_INSTALLER_NAME="$PKG_NAME.pkg"

triggerBuild() {
    DEFAULT_GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
    GIT_BRANCH="${GIT_BRANCH:-$DEFAULT_GIT_BRANCH}"

    stdout "Triggering remote darwin installer build of branch $GIT_BRANCH at $MOBILECI_BASE_URL"

    set +x
    echo $NO_PROXY
    echo $OPS_NO_PROXY
    echo $HTTPS_PROXY
    git config --list
    set -x
}

cpAssetFromSigned() {
  SIGNED_TAG="v$SHORT_VERSION-Signed"
  TAG="v$SHORT_VERSION"
  ASSET_FILE_NAME="$VERSIONED_INSTALLER_NAME"
  # Get the tag and signed-tag asset ids from git
  UNSIGNED_ASSET_ID=$(curl -H "Accept: application/vnd.github.v3+json" "$GIT_BASE/tags" | jq "$TAG.assets[].id")
  SIGNED_ASSET_ID=$(curl -H "Accept: application/vnd.github.v3+json" "$GIT_BASE/tags" | jq "$SIGNED_TAG.assets[].id")
  # Copy signed asset from <tag>-Signed back to the regular tag name (download and then upload)
  # get the first entry, they're sorted from newest release to oldest
  GIT_RELEASE_ID=$(curl -sSL -H "Authorization: token $GIT_TOKEN" -H "Accept: application/octet-stream" "$GIT_BASE/releases/" | jq '.[0].id')
  curl -sSL -H "Authorization: token $GIT_TOKEN" -H "Accept: application/octet-stream" "$GIT_BASE/releases/$GIT_RELEASE_ID/assets/$SIGNED_ASSET_ID" > $ASSET_FILE_NAME
  # Upload the artifact that was just moved to the Jenkins workspace to the release asset location
  curl -X POST --data-binary "@$ASSET_FILE_NAME" -H "Content-type: application/octet-stream" -H "Authorization: token $GIT_TOKEN" "$GIT_BASE/releases/$GIT_RELEASE_ID/assets/$UNSIGNED_ASSET_ID/assets?name=$ASSET_FILE_NAME"
}

pollGhAndCopyToS3() {
    ASSET_FILE_NAME="$VERSIONED_INSTALLER_NAME"
    TAG="v$SHORT_VERSION-Signed"

    stdout "Polling github release $TAG for $ASSET_FILE_NAME"
    ASSET_URL=$(ghPollForAssetUrl "$ASSET_FILE_NAME")

    cd "$RELEASE_DIR"

    ghDownloadAsset "$ASSET_FILE_NAME"
    cp "$VERSIONED_INSTALLER_NAME" "$UNVERSIONED_INSTALLER_NAME"

    stdout "Releasing darwin installers to $CHANNEL"

    resetS3CacheDir

    cp "$VERSIONED_INSTALLER_NAME" "$UNVERSIONED_INSTALLER_NAME" "$S3_CACHE_DIR"

    s3upload "$VERSIONED_CACHE_CONTROL" \
        "$S3_CACHE_DIR/$VERSIONED_INSTALLER_NAME" \
        "$S3_CHANNEL_UPLOAD_URL/$VERSIONED_INSTALLER_NAME"

    s3upload "$UNVERSIONED_CACHE_CONTROL" \
        "$S3_CACHE_DIR/$UNVERSIONED_INSTALLER_NAME" \
        "$S3_CHANNEL_UPLOAD_URL/$UNVERSIONED_INSTALLER_NAME"
}

ghUploadAsset "$TXZ_PATH" "$VERSIONED_BASE.tar.xz"
ghDeleteAssetIfExists "$RELEASE_JSON" "$VERSIONED_INSTALLER_NAME"
triggerBuild
pollGhAndCopyToS3
# cpAssetFromSigned
addToManifest "installers" "${OS}-${ARCH}" "$S3_HOST_CHANNEL_BASE_URL/$VERSIONED_INSTALLER_NAME" "$RELEASE_DIR/$VERSIONED_INSTALLER_NAME"
