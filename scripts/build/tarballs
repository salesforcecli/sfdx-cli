#!/usr/bin/env bash

# creates tarballs from the workspace into dist

source ./scripts/_init

set -ex

# create tarballs
cd "$RELEASE_DIR"

function build () {
    # must be a directory in this format
    # but it is difficult to work with the version number in other places
    mv "$WORKSPACE_DIR" "$VERSIONED_BASE"

    tar c "$VERSIONED_BASE" | xz > "$TXZ_PATH" &
    local xzpid=$!
    tar czf "$TGZ_PATH" "$VERSIONED_BASE"
    wait $xzpid || exit 1
    TGZ_FILE="$VERSIONED_BASE.tar.gz"
    cp "$TGZ_PATH" "$TGZ_FILE"
    TXZ_FILE="$VERSIONED_BASE.tar.xz"
    cp "$TXZ_PATH" "$TXZ_FILE"

    mv "$VERSIONED_BASE" "$WORKSPACE_DIR"

    SHA256_GZ=$(sha "$TGZ_PATH")
    SHZ256_XZ=$(sha "$TXZ_PATH")
    cat << EOF > "$RELEASE_DIR/${OS}-${ARCH}"
{
    "version": "${VERSION}",
    "channel": "${CHANNEL}",
    "baseDir": "${BIN_NAME}",
    "gz": "${TGZ_FILE}",
    "xz": "${TXZ_FILE}",
    "sha256gz": "${SHA256_GZ}",
    "sha256xz": "${SHZ256_XZ}",
    "node": {
        "compatible": "${NODE_REQUIRED}",
        "recommended": "${NODE_VERSION}"
    }
}
EOF
    cp "$RELEASE_DIR/${OS}-${ARCH}" "$RELEASE_VERSION_DIR/${OS}-${ARCH}"
}

for ARCH in "${ARCHS[@]}"; do
    setarch "$ARCH"
    bg build
done
wait_all
